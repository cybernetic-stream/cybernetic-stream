name: Build and Deploy Fleet Sourcing

on:
  push:
    branches:
      - main
#    paths:
#      - "data/fleet/Sourcing/**"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          registry: docker.io
          username: usernamex36
          password: ${{ secrets.DOCKERHUB_TOKEN }}

#      - name: Build and push to Docker Hub
#        uses: docker/build-push-action@v2
#        with:
#          context: ./data/fleet/Sourcing
#          file: ./data/fleet/Sourcing/Dockerfile
#          platforms: linux/amd64
#          push: true
#          tags: docker.io/usernamex36/fleet-sourcing:latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2.0.0
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Google Cloud
        uses: google-github-actions/setup-gcloud@v2.0.1
        with:
          project_id: projectid-x

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker

      - name: Deploy to Cloud Run
        run: |
          # Deploy to Cloud Run with environment variables
          gcloud run deploy fleet-sourcing \
            --execution-environment=gen2 \
            --image docker.io/usernamex36/fleet-sourcing:latest \
            --platform managed \
            --region us-west2 \
            --memory 2Gi \
            --cpu 1 \
            --allow-unauthenticated \
            --cpu-boost \
            --set-env-vars [ADESA_PASSWORD='NE7*p3!hNzKcbkgfL4mB',R2_SECRET_ACCESS_KEY='b25156e5c0b5aaa0de3dbf55d2386ee5fccdf46443e6513c11796465e2948739',GCP_SERVICE_ACCOUNT='ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAicHJvamVjdGlkLXgiLAogICJwcml2YXRlX2tleV9pZCI6ICIyYTVjZDg5NDk3NmYwZWZiMzQ3NjdiZTExMDA5ZTkyZDkwOTAzMDE1IiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUMybWxzdk1sRWlPdHVaXG5oODZ2NjVHT21SUEtkUUxnMm5GUlhsSDRkcjVZN1pzNVBhVGJXdllSN2d6Yi9IQ0E4UTZudjR2bXZDQ29tbGdTXG5yK093MGh6dm9kNXhWbUpYaGJVbEhuNTBqUUNSRzA3ODZvdm5QUlIva25mczdDZTdUQ1cvblFBREpCd2laL3dNXG5WMWJaQVNJVGxaSHBLcVZJZjFWVXllUDIvNGhpN3pReWhCYTFpWUhOWmFqKzdPdlc2T2hrWFBxWkZaVzRFMCtCXG4zVUxxMERha3cwbTA0aGFHN2c2UlFzVWMwRmJHOXNlL3BBdzkzZVBHbnlScXVzcTVLeVNNNTRiZHlrVURaS3JBXG5CbWk4bkZ2YTZpbGxIcFh1MlBQK1JmN2Q5TEdQMnBoaWErVFRvb3dZQzJFTjVnYkFZUmorUWI2dU8xOG5YbFhoXG5Eb29NVTAvN0FnTUJBQUVDZ2dFQVArVDdDeVM4SnhJWlRUdXNJdnAyMEVMWUhmdWJxanBGZElkZ2YyUnRib2lWXG56QTI1NWRlS1N2UFZKQlRNK1JGZ1kyb3U5ZW5XTTZqdU1IdkRYRmZwTUNDZnlXREV3SU5VdzB4TVMxUWJZcXIvXG5sSmd0cEJoSFYreFVjbDZmK0hYSXI2ZXNIVzFCT3ZqUHhURzZmZXhibENhK0M2eVVjUzI5R2hJYTVvNjdsb0l0XG5LNG9CMEFQVHN1UFlXNTkwbHl4RUg4R0hHWHRLR1AyZXZlemt0Z2pmOFBnaTV6NTVPVTlhM3B3aVBuNjdSd1ZMXG50eHdJbjRaM0tJNjRKcytHWTdXT3oxbUY2anExSDJxWmFLTUJScTczOTdkZHlDK1VOYVZjdm11Q2RXZVpMQ1daXG5wYUxxZjJCaEZtWUo3dlRPVjl2clUrdlFOOUtzR2podVEyZUZVeHB1QVFLQmdRRHBnbk5WM0lFWjJGSEYyNytDXG5rR3BmdWFLYjRCd1EzV1c4WFZJRkF1UTdPaUMrTnB5ZHNFNFFxM3Z1UURIelpjb09keXdVWEovNmk1andVeDcwXG5nVys2RjFPbFJrNEFsYWt3alhRK1lZVjBpN1ROWEZ3VmJEazJCVGdOMndEL3hrdG9rUThEWGZWdTV2OVIxeUhUXG5STHE4MEROaTYzbThvUm9QeE1MZkV5UTV3UUtCZ1FESU1MamNFR0tjSUpOV1pRczBQZlN5RDRtcVlJaVlKRG5WXG4wTjNwUVI5UDFoSXVRMXVTQm9nd2QrVWE0b0NLS2dWYWJ4alFhUzJWSFNGQmVLVWNndUtNa0l0NDRhWDdMRHAyXG5vajdSOTVraEJFbHYzWkI4UVNUZmR6TFF6bE9yMmVxU3NKU20yUzFtSzJMRitIME5tL1F6WGo5QXRHUG9UdTlLXG4ySDNDNE9VZ3V3S0JnUUNWRjBsMHBObDVHdmo3RDVkelVhblpmTGtxTlNrMlMyWE5vdmZmWXowOTQ1dE1WNm9mXG50SlhqWnRvMkFKN2ovVFhKanFXQ1NyR0tVdDlQY29MdE1rZVgxWlQramFqNERwWjcvWlVlenoxYWNHajhSZUExXG5mV2Y1NmRNa1paUjV1cTRqRVpzNFZ5R0JzZE9LK1lVTFUzSzNZMmVyM1JWWkxyTnBKZ1FXVWk1ckFRS0JnR0ZzXG5oS3BrTnZrd1NVUGtUTDJSNFVHK21ncVdqQ011amc3bVpQaWRQclhGd25kTlJJVWVOSzBSekNkM1Q0THR6RWtrXG5nL2o1RnJ2WXYxUnplRGNWNDFieENVODgwV0FaT0NKLzl2Nkw5clBBdUZSK2lWQlBDN2pNODZmMm9YV2l5YXUxXG56OEliTXlManZtQUYvQ1hoWGNpWjkwSndCNmNJc3gvRG1BQjlIa1Q5QW9HQkFPWXgzcUpyd0U0VEVVYnF2aWZTXG51eE1MVG5wLzUwRVlwNlQvRTJnNjBmcmhJSlZLREE3ODFLQ3NDVFJsT1RrZWdNTzY5UEpnMHdzZ2Vac095U1R4XG5RVERvUUFWc1huaEM4bWxxZjVXa00vU05pSTJwMU4xZWtIMEIzN1NnVTVtcmFwNTJEUUFEUFUyOHFMTVB1RXZ1XG5ia3kybmFBSjNJMEVmZEM3dHJYeSt2Z2xcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJzZXJ2aWNlLWFjY291bnQtbmFtZUBwcm9qZWN0aWQteC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDM2NjkzODE1MTA4NzA2MDg1MDciLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L3NlcnZpY2UtYWNjb3VudC1uYW1lJTQwcHJvamVjdGlkLXguaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K']