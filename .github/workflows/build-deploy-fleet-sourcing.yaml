name: Build and Deploy Fleet Sourcing

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: glendenning-barn
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          registry: docker.io
          username: usernamex36
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v2
        with:
          context: ./data/fleet/Sourcing
          file: ./data/fleet/Sourcing/Dockerfile
          platforms: linux/amd64
          push: true
          tags: docker.io/usernamex36/fleet-sourcing:latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2.0.0
        with:
          credentials_json: '$(eyJ0eXBlIjoic2VydmljZV9hY2NvdW50IiwicHJvamVjdF9pZCI6InByb2plY3RpZC14IiwicHJpdmF0ZV9rZXlfaWQiOiIyYTVjZDg5NDk3NmYwZWZiMzQ3NjdiZTExMDA5ZTkyZDkwOTAzMDE1IiwicHJpdmF0ZV9rZXkiOiItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQzJtbHN2TWxFaU90dVpcbmg4NnY2NUdPbVJQS2RRTGcybkZSWGxINGRyNVk3WnM1UGFUYld2WVI3Z3piL0hDQThRNm52NHZtdkNDb21sZ1NcbnIrT3cwaHp2b2Q1eFZtSlhoYlVsSG41MGpRQ1JHMDc4Nm92blBSUi9rbmZzN0NlN1RDVy9uUUFESkJ3aVovd01cblYxYlpBU0lUbFpIcEtxVklmMVZVeWVQMi80aGk3elF5aEJhMWlZSE5aYWorN092VzZPaGtYUHFaRlpXNEUwK0JcbjNVTHEwRGFrdzBtMDRoYUc3ZzZSUXNVYzBGYkc5c2UvcEF3OTNlUEdueVJxdXNxNUt5U001NGJkeWtVRFpLckFcbkJtaThuRnZhNmlsbEhwWHUyUFArUmY3ZDlMR1AycGhpYStUVG9vd1lDMkVONWdiQVlSaitRYjZ1TzE4blhsWGhcbkRvb01VMC83QWdNQkFBRUNnZ0VBUCtUN0N5UzhKeElaVFR1c0l2cDIwRUxZSGZ1YnFqcEZkSWRnZjJSdGJvaVZcbnpBMjU1ZGVLU3ZQVkpCVE0rUkZnWTJvdTllbldNNmp1TUh2RFhGZnBNQ0NmeVdERXdJTlV3MHhNUzFRYllxci9cbmxKZ3RwQmhIVit4VWNsNmYrSFhJcjZlc0hXMUJPdmpQeFRHNmZleGJsQ2ErQzZ5VWNTMjlHaElhNW82N2xvSXRcbks0b0IwQVBUc3VQWVc1OTBseXhFSDhHSEdYdEtHUDJldmV6a3RnamY4UGdpNXo1NU9VOWEzcHdpUG42N1J3VkxcbnR4d0luNFozS0k2NEpzK0dZN1dPejFtRjZqcTFIMnFaYUtNQlJxNzM5N2RkeUMrVU5hVmN2bXVDZFdlWkxDV1pcbnBhTHFmMkJoRm1ZSjd2VE9WOXZyVSt2UU45S3NHamh1UTJlRlV4cHVBUUtCZ1FEcGduTlYzSUVaMkZIRjI3K0NcbmtHcGZ1YUtiNEJ3UTNXVzhYVklGQXVRN09pQytOcHlkc0U0UXEzdnVRREh6WmNvT2R5d1VYSi82aTVqd1V4NzBcbmdXKzZGMU9sUms0QWxha3dqWFErWVlWMGk3VE5YRndWYkRrMkJUZ04yd0QveGt0b2tROERYZlZ1NXY5UjF5SFRcblJMcTgwRE5pNjNtOG9Sb1B4TUxmRXlRNXdRS0JnUURJTUxqY0VHS2NJSk5XWlFzMFBmU3lENG1xWUlpWUpEblZcbjBOM3BRUjlQMWhJdVExdVNCb2d3ZCtVYTRvQ0tLZ1ZhYnhqUWFTMlZIU0ZCZUtVY2d1S01rSXQ0NGFYN0xEcDJcbm9qN1I5NWtoQkVsdjNaQjhRU1RmZHpMUXpsT3IyZXFTc0pTbTJTMW1LMkxGK0gwTm0vUXpYajlBdEdQb1R1OUtcbjJIM0M0T1VndXdLQmdRQ1ZGMGwwcE5sNUd2ajdENWR6VWFuWmZMa3FOU2syUzJYTm92ZmZZejA5NDV0TVY2b2ZcbnRKWGpadG8yQUo3ai9UWEpqcVdDU3JHS1V0OVBjb0x0TWtlWDFaVCtqYWo0RHBaNy9aVWV6ejFhY0dqOFJlQTFcbmZXZjU2ZE1rWlpSNXVxNGpFWnM0VnlHQnNkT0srWVVMVTNLM1kyZXIzUlZaTHJOcEpnUVdVaTVyQVFLQmdHRnNcbmhLcGtOdmt3U1VQa1RMMlI0VUcrbWdxV2pDTXVqZzdtWlBpZFByWEZ3bmROUklVZU5LMFJ6Q2QzVDRMdHpFa2tcbmcvajVGcnZZdjFSemVEY1Y0MWJ4Q1U4ODBXQVpPQ0ovOXY2TDlyUEF1RlIraVZCUEM3ak04NmYyb1hXaXlhdTFcbno4SWJNeUxqdm1BRi9DWGhYY2laOTBKd0I2Y0lzeC9EbUFCOUhrVDlBb0dCQU9ZeDNxSnJ3RTRURVVicXZpZlNcbnV4TUxUbnAvNTBFWXA2VC9FMmc2MGZyaElKVktEQTc4MUtDc0NUUmxPVGtlZ01PNjlQSmcwd3NnZVpzT3lTVHhcblFURG9RQVZzWG5oQzhtbHFmNVdrTS9TTmlJMnAxTjFla0gwQjM3U2dVNW1yYXA1MkRRQURQVTI4cUxNUHVFdnVcbmJreTJuYUFKM0kwRWZkQzd0clh5K3ZnbFxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwiY2xpZW50X2VtYWlsIjoic2VydmljZS1hY2NvdW50LW5hbWVAcHJvamVjdGlkLXguaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGllbnRfaWQiOiIxMDM2NjkzODE1MTA4NzA2MDg1MDciLCJhdXRoX3VyaSI6Imh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwidG9rZW5fdXJpIjoiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLCJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLCJjbGllbnRfeDUwOV9jZXJ0X3VybCI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvc2VydmljZS1hY2NvdW50LW5hbWUlNDBwcm9qZWN0aWQteC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsInVuaXZlcnNlX2RvbWFpbiI6Imdvb2dsZWFwaXMuY29tIn0= | base64 --decode)'

      - name: Set up Google Cloud
        uses: google-github-actions/setup-gcloud@v2.0.1
        with:
          project_id: projectid-x

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy fleet-sourcing \
            --execution-environment=gen2 \
            --image docker.io/usernamex36/fleet-sourcing:latest \
            --platform managed \
            --region us-west2 \
            --memory 2Gi \
            --cpu 1 \
            --allow-unauthenticated \
            --cpu-boost \
            --set-env-vars ADESA_PASSWORD='NE7*p3!hNzKcbkgfL4mB',R2_SECRET_ACCESS_KEY='b25156e5c0b5aaa0de3dbf55d2386ee5fccdf46443e6513c11796465e2948739',GCP_SERVICE_ACCOUNT_JSON="$(echo ${{ secrets.GCP_SERVICE_ACCOUNT }} | base64 --decode)"
